import { useParams, useNavigate } from 'react-router-dom'
import { useEffect, useState, useContext, useRef, useCallback } from 'react'
import OtherProfileNoteItem from './NoteItems/OtherProfileNoteItem'
import noteContext from '../context/notes/NoteContext'
import OwnNoteItem from './NoteItems/OwnNoteItem'
import NoteUpdateModal from './models/NoteUpdateModal'
import Addnote from './Addnote'
import { Plus, Edit3, CameraIcon } from 'lucide-react'
import Search from './Search'
import UserListModal from './models/UserListModal'
import EditProfileModel from './models/EditProfileModel'
import Loader from './utils/Loader'
import ProfileHeader from './utils/ProfileHeader'

const OthersProfile = ({ loggedInUser, showAlert }) => {
  // Validate token
  useEffect(() => {
    const storedToken = localStorage.getItem('token')
    if (!storedToken) {
      navigate('/login')
    }
  }, [navigate])
  const { notes, getNotes, editNote } = useContext(noteContext)
  const { username: initialUsername } = useParams()
  const [username, setUsername] = useState(initialUsername)
  const [user, setUser] = useState(null)
  const [error, setError] = useState(null)
  const [sortCriteria, setSortCriteria] = useState('modifiedDate')
  const [sortOrder, setSortOrder] = useState('desc')
  const [isFollowing, setIsFollowing] = useState(false)
  const [isEditProfileModelOpen, setIsEditProfileModelOpen] = useState(false)
  const [isNoteAddModelOpen, setIsNoteAddModelOpen] = useState(false)
  const [isUpdateNoteModalOpen, setIsUpdateNoteModalOpen] = useState(false)
  const addNoteModalRef = useRef(null)
  const updateNoteModalRef = useRef(null)
  const [filterText, setFilterText] = useState('')
  const [isOwnProfile, setIsOwnProfile] = useState(false)
  const [currentNote, setCurrentNote] = useState(null)
  const [editProfileData, setEditProfileData] = useState({
    username: '',
    name: ''
  })

  const hostLink = process.env.REACT_APP_HOSTLINK
  const imageAPI = process.env.REACT_APP_IMAGEAPI
  const navigate = useNavigate()

  // Memoize modal functions
  const openModal = useCallback((type) => setModalType(type), [])
  const closeModal = useCallback(() => {
    setModalType(null)
    setIsUserListModalOpen(false)
  }, [])

  // Handle token check
  useEffect(() => {
    const storedToken = localStorage.getItem('token')
    if (!storedToken) {
      navigate('/login')
      return
    }

    const params = new URLSearchParams(window.location.search)
    const token = params.get('token')

    if (token) {
      localStorage.setItem('token', token)
      const cleanUrl = window.location.origin + window.location.pathname
      window.history.replaceState({}, document.title, cleanUrl)
      navigate('/')
    }
  }, [navigate])

  // Handle body scroll lock for modals
  useEffect(() => {
    const isAnyModalOpen =
      isEditProfileModelOpen ||
      isUserListModal ||
      isNoteAddModelOpen ||
      isUpdateNoteModalOpen ||
      isLightboxOpen

    document.body.style.overflow = isAnyModalOpen ? 'hidden' : 'auto'

    return () => {
      document.body.style.overflow = 'auto'
    }
  }, [isEditProfileModelOpen, isUserListModal, isNoteAddModelOpen, isUpdateNoteModalOpen, isLightboxOpen])

  // Close lightbox on Escape key
  useEffect(() => {
    const onKeyDown = (e) => {
      if (e.key === 'Escape' && isLightboxOpen) {
        setIsLightboxOpen(false)
      }
    }
    window.addEventListener('keydown', onKeyDown)
    return () => window.removeEventListener('keydown', onKeyDown)
  }, [isLightboxOpen])

  const toggleAddNoteModal = () => {
    if (addNoteModalRef.current) {
      addNoteModalRef.current.classList.toggle('hidden')
      setIsNoteAddModelOpen(!addNoteModalRef.current.classList.contains('hidden'))
    }
  }

  const toggleEditProfileModal = useCallback(() => {
    setIsEditProfileModelOpen((prev) => {
      if (!prev && user) {
        setEditProfileData({ username: user.username || '', name: user.name || '' })
      }
      return !prev
    })
  }, [user])

  const toggleUpdateNoteModal = () => {
    if (updateNoteModalRef.current) {
      updateNoteModalRef.current.classList.toggle('hidden')
      setIsUpdateNoteModalOpen(!updateNoteModalRef.current.classList.contains('hidden'))
    }
  }

  const fetchUserProfile = useCallback(async (username) => {
    try {
      const response = await fetch(`${hostLink}/api/user/${username}`, {
        headers: {
          'auth-token': localStorage.getItem('token')
        }
      })

      if (!response.ok) {
        if (response.status === 404) {
          setError('User not found.')
        } else {
          setError('Failed to load user profile.')
        }
        setUser(null)
        return
      }

      const data = await response.json()
      setUser(data)
      setIsFollowing(data.isFollowing || false)
    } catch (error) {
      console.error('Error fetching user profile:', error)
      setError('Something went wrong while loading the user profile.')
    }
  }, [hostLink])

  // Fetch user profile when username changes
  useEffect(() => {
    if (username) {
      fetchUserProfile(username)
      // Reset modal states when username changes
      setIsEditProfileModelOpen(false)
      setIsUserListModalOpen(false)
      setModalType(null)
      setCurrentNote(null)
    }
  }, [username, fetchUserProfile])

  // Update username from params
  useEffect(() => {
    setUsername(initialUsername)
  }, [initialUsername])

  // Check if viewing own profile and fetch notes
  useEffect(() => {
    const isOwn = loggedInUser?.username === username
    setIsOwnProfile(isOwn)
    if (isOwn && getNotes) {
      getNotes()
    }
  }, [username, loggedInUser?.username, getNotes])

  // Update document title
  useEffect(() => {
    if (user) {
      document.title = `${username} || Wryta`
    }
  }, [user, username])

  const updateNote = (note) => {
    setCurrentNote(note)
    toggleUpdateNoteModal()
  }

  const handleEditProfileChange = useCallback((e) => {
    setEditProfileData(prev => ({ ...prev, [e.target.name]: e.target.value }))
  }, [])

  const handleEditProfileSubmit = async (e) => {
    e.preventDefault()
    const updatedData = {
      username: editProfileData.username || user.username,
      name: editProfileData.name || user.name
    }

    try {
      const response = await fetch(`${hostLink}/api/auth/updateprofile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'auth-token': localStorage.getItem('token')
        },
        body: JSON.stringify(updatedData)
      })
      const json = await response.json()

      if (json.success) {
        setUser(json.user)
        toggleEditProfileModal()
        if (updatedData.username !== user.username) {
          setUsername(updatedData.username)
          navigate(`/u/${updatedData.username}`)
          window.location.reload()
        }
        showAlert('Profile updated successfully', '#D4EDDA')
      } else {
        const errorMsg =
        json.errors?.[0]?.msg || // express-validator error
        json.error || // custom backend error
        'Something went wrong'
        showAlert(errorMsg, '#F8D7DA')
      }
    } catch (error) {
      console.error('Error updating profile:', error)
      showAlert(error.msg, '#F8D7DA')
    }
  }

  const followUnfollow = async () => {
    try {
      const endpoint = isFollowing ? 'unfollow' : 'follow'
      await fetch(`${hostLink}/api/user/${endpoint}/${user.id}`, {
        method: 'POST',
        headers: {
          'auth-token': localStorage.getItem('token')
        }
      })
      setIsFollowing(!isFollowing)
      fetchUserProfile(username)
    } catch (error) {
      console.error('Error updating follow status:', error)
      showAlert('Failed to update follow status', '#F8D7DA')
    }
  }

  // Error screen
  if (error) {
    return (
      <div className='flex items-center justify-center min-h-screen bg-[#0a1122]'>
        <div className='text-center text-gray-300'>
          <h2 className='text-2xl font-bold mb-2'>
            {error.includes('User') ? '404 User Not Found' : 'Unable to load user'}
          </h2>
          <p className='text-gray-400'>{error}</p>
        </div>
      </div>
    )
  }

  // Loading screen
  if (!user) {
    return <Loader />
  }

  const profilePic = user.profilePic || `${imageAPI}${encodeURIComponent(username)}`
  const notesToDisplay = isOwnProfile ? notes : user.publicNotes || []

  const filteredNotes = notesToDisplay.filter((note) =>
    note.title.toLowerCase().includes(filterText.toLowerCase()) ||
    note.description.toLowerCase().includes(filterText.toLowerCase()) ||
    note.tag.toLowerCase().includes(filterText.toLowerCase())
  )

  const sortedNotesToDisplay = [...filteredNotes].sort((a, b) => {
    const dateA = new Date(a[sortCriteria] || a.date)
    const dateB = new Date(b[sortCriteria] || b.date)
    return sortOrder === 'old' ? dateA - dateB : dateB - dateA
  })

    // Error screen
  if (error) {
    return (
      <div className='flex items-center justify-center min-h-screen bg-[#0a1122]'>
        <div className='text-center text-gray-300'>
          <h2 className='text-2xl font-bold mb-2'>
            {error.includes('User') ? '404 User Not Found' : 'Unable to load user'}
          </h2>
          <p className='text-gray-400'>{error}</p>
        </div>
      </div>
    )
  }

  // Loading screen
  if (!user) {
    return <Loader />
  }

  const userProfilePic = user.profilePic || `${imageAPI}${encodeURIComponent(username)}`
  const notesList = isOwnProfile ? notes : user.publicNotes || []

  const filteredNotesList = notesList.filter((note) =>
    note.title.toLowerCase().includes(filterText.toLowerCase()) ||
    note.description.toLowerCase().includes(filterText.toLowerCase()) ||
    note.tag.toLowerCase().includes(filterText.toLowerCase())
  )

  const sortedNotesList = [...filteredNotesList].sort((a, b) => {
    const dateA = new Date(a[sortCriteria] || a.date)
    const dateB = new Date(b[sortCriteria] || b.date)
    return sortOrder === 'old' ? dateA - dateB : dateB - dateA
  })

  return (
    <div className="min-h-screen bg-[#0a1122]">
      <Search
        filterText={filterText}
        setFilterText={setFilterText}
        className='fixed left-0 w-full bg-gray-900 z-40 px-4 shadow-md'
      />

      {/* Profile Section */}
      <EditProfileModel
        isOpen={isEditProfileModelOpen}
        onClose={() => setIsEditProfileModelOpen(false)}
        initialData={editProfileData}
        onChange={handleEditProfileChange}
        onSubmit={handleEditProfileSubmit}
      />

      <ProfileHeader
        username={username}
        profilePic={userProfilePic}
        isOwnProfile={isOwnProfile}
        name={user.name}
        bio={user.bio}
        totalNotes={user.totalNotes}
        publicNotesCount={user.publicNotesCount}
        followerCount={user.followerCount}
        followingCount={user.followingCount}
        loggedInUser={loggedInUser}
        userId={user.id}
        setIsEditProfileModelOpen={setIsEditProfileModelOpen}
        isFollowing={isFollowing}
        onFollowToggle={followUnfollow}
        followerList={user.followerList}
        followingList={user.followingList}
        showAlert={showAlert}
      />

      {/* Note Modals */}
      {isOwnProfile && (
        <>
          <Addnote
            modalRef={addNoteModalRef}
            showAlert={showAlert}
            toggleModal={toggleAddNoteModal}
            isOpen={isNoteAddModelOpen}
          />

          <NoteUpdateModal
            modalRef={updateNoteModalRef}
            currentNote={currentNote}
            editNote={editNote}
            showAlert={showAlert}
            toggleModal={toggleUpdateNoteModal}
            isOpen={isUpdateNoteModalOpen}
          />
        </>
      )}

      {/* Notes Section */}
      <div className="container mx-auto px-4 mt-8">
        </div>
      </div>

      <div className='flex gap-2 mb-3 px-4'>
        <select
          value={sortCriteria}
          onChange={(e) => setSortCriteria(e.target.value)}
          className='px-4 py-2 text-sm rounded-full border bg-[#1E293B] text-white border-gray-600 hover:border-white hover:bg-[#374151]'
        >
          <option value='modifiedDate'>Modified Date</option>
          <option value='date'>Created Date</option>
        </select>
        <select
          value={sortOrder}
          onChange={(e) => setSortOrder(e.target.value)}
          className='px-4 py-2 text-sm rounded-full border bg-[#1E293B] text-white border-gray-600 hover:border-white hover:bg-[#374151]'
        >
          <option value='new'>Newest</option>
          <option value='old'>Oldest</option>
        </select>
      </div>

      <div className='w-full flex flex-wrap text-white gap-3 mt-4 px-4'>
        {sortedNotesToDisplay.length > 0
          ? (
              sortedNotesToDisplay.map((note) =>
                isOwnProfile
                  ? (
                    <OwnNoteItem
                      key={note._id}
                      note={note}
                      updateNote={updateNote}
                      showAlert={showAlert}
                      image={profilePic}
                      username={user.username}
                    />
                    )
                  : (
                    <OtherProfileNoteItem
                      key={note._id}
                      noteId={note._id}
                      title={note.title}
                      description={note.description}
                      date={note.date}
                      modifiedDate={note.modifiedDate}
                      tag={note.tag}
                      showAlert={showAlert}
                      image={profilePic}
                      username={user.username}
                      note={note}
                    />
                    )
              )
            )
          : (
            <p className='text-center text-gray-400 w-full'>No notes available.</p>
            )}
      </div>

      {loggedInUser && (
        <button
          onClick={toggleAddNoteModal}
          className='fixed bottom-10 right-10 bg-blue-500 text-white rounded-full p-2 shadow-lg hover:bg-blue-600 focus:outline-none'
        >
          <Plus size={50} />
        </button>
      )}

      {modalType === 'followers' && isUserListModal && (
        <UserListModal
          title='Followers'
          users={user.followerList || []}
          onClose={closeModal}
          isOpen={isUserListModal}
        />
      )}
      {modalType === 'following' && isUserListModal && (
        <UserListModal
          title='Following'
          users={user.followingList || []}
          onClose={closeModal}
          isOpen={isUserListModal}
        />
      )}
    </>
  )
}

export default OthersProfile
